<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Chilanka&display=swap" rel="stylesheet">

<title>Village Data Base | KSITM Alappuzha</title>

<style>
body {
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 20px;
    background-color: #f4f4f4;
}
h1, p { text-align: center; }
#filters {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-bottom: 20px;
    align-items: center;
    flex-wrap: wrap;
}
#search-bar, #taluk-dropdown {
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 5px;
    font-size: 1em;
}
#village-count { font-weight: bold; }
#last-updated {
    position: fixed;
    top: 10px;
    right: 20px;
    font-size: 0.85em;
    background: #fff;
    padding: 5px 10px;
    border-radius: 5px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
#taluk-list { list-style: none; padding: 0; }
.taluk-item {
    background: #fff;
    padding: 15px;
    margin-bottom: 10px;
    border-radius: 6px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.taluk-item h3 { margin: 0 0 5px; }
</style>
</head>

<body>

<h1 style="font-family: Chilanka;">ENTE VILLAGE-‡¥é‡¥®‡µç‡¥±‡µÜ ‡¥µ‡¥ø‡¥≤‡µç‡¥≤‡µá‡¥ú‡µç</h1>
<p style="font-family: Chilanka;">‡¥Ü‡¥≤‡¥™‡µç‡¥™‡µÅ‡¥¥ ‡¥ú‡¥ø‡¥≤‡µç‡¥≤‡¥Ø‡¥ø‡¥≤‡µÜ ‡¥µ‡¥ø‡¥≤‡µç‡¥≤‡µá‡¥ú‡µç ‡¥ì‡¥´‡µÄ‡¥∏‡µÅ‡¥ï‡¥≥‡µÅ‡¥ü‡µÜ ‡¥í‡¥∞‡µÅ ‡¥ï‡µÅ‡¥ü‡µç‡¥ü‡¥ø ‡¥°‡¥æ‡¥±‡µç‡¥±‡¥æ‡¥¨‡µá‡¥∏‡µç</p>
<p style="font-family: Chilanka;">A tiny database of village offices in Alappuzha district</p>

<div id="filters">
    <input type="text" id="search-bar" placeholder="Search anything..." oninput="filterTaluks()">
    <select id="taluk-dropdown" onchange="filterTaluks()">
        <option value="">Select Taluk</option>
    </select>
    <span id="village-count">0 Villages</span>
</div>

<div id="loading-message" style="text-align:center;">Loading...</div>
<ul id="taluk-list"></ul>
<div id="last-updated"></div>

<script>
const jsonUrl = 'https://raw.githubusercontent.com/josephjosedev/TESTNODE/main/villagedb.json';
const githubApiUrl = 'https://api.github.com/repos/josephjosedev/TESTNODE/commits/main';

let allTaluks = [];

/* Fetch data */
fetch(githubApiUrl)
    .then(res => res.json())
    .then(commit => {
        const d = new Date(commit.commit.committer.date);
        document.getElementById('last-updated').innerText =
            'Last Updated: ' + d.toLocaleString();
        return fetch(jsonUrl);
    })
    .then(res => res.json())
    .then(data => {
        allTaluks = data;
        populateTalukDropdown();
        displayTaluks(allTaluks);
        updateVillageCount(allTaluks);
        document.getElementById('loading-message').style.display = 'none';
    })
    .catch(() => {
        document.getElementById('loading-message').innerText = 'Failed to load data';
    });

/* Populate dropdown */
function populateTalukDropdown() {
    const dropdown = document.getElementById('taluk-dropdown');
    const taluks = [...new Set(
        allTaluks.map(t => String(t['Taluk'] ?? '').trim()).filter(Boolean)
    )];

    taluks.forEach(t => {
        const opt = document.createElement('option');
        opt.value = t;
        opt.textContent = t;
        dropdown.appendChild(opt);
    });
}

/* Render cards */
function displayTaluks(data) {
    const list = document.getElementById('taluk-list');
    list.innerHTML = '';

    data.forEach(t => {
        const li = document.createElement('li');
        li.className = 'taluk-item';
        li.innerHTML = `
            <h3>${t['Village Name'] ?? ''}</h3>
            <p><strong>Taluk:</strong> ${t['Taluk'] ?? ''}</p>
            <p><strong>Village Officer:</strong> ${t['Village Officer Name'] ?? ''}</p>
            <p><strong>Mobile:</strong> ${t['Mobile_Number'] ?? ''}</p>
            <p><strong>Email:</strong> ${t['Official Mail ID'] ?? ''}</p>
            <p><strong>Pincode:</strong> ${t['Pincode'] ?? ''}</p>
            <p><strong>FTTH No:</strong> ${t['FTTH NO.'] ?? ''}</p>
        `;
        list.appendChild(li);
    });
}

/* Count villages */
function updateVillageCount(data) {
    const villages = new Set(
        data
            .map(t => String(t['Village Name'] ?? '').trim().toLowerCase())
            .filter(Boolean)
    );
    document.getElementById('village-count').innerText =
        `${villages.size} Villages`;
}

/* üîç FINAL SEARCH (FULL JSON TEXT SEARCH) */
function filterTaluks() {
    const query = document.getElementById('search-bar').value
        .trim()
        .toLowerCase();

    const selectedTaluk = document.getElementById('taluk-dropdown').value;

    const filtered = allTaluks.filter(taluk => {

        // üîπ Convert entire object to searchable text
        const fullText = Object.entries(taluk)
            .map(([_, v]) => String(v ?? ''))
            .join(' ')
            .toLowerCase();

        const matchSearch = query === '' || fullText.includes(query);
        const matchTaluk =
            selectedTaluk === '' ||
            String(taluk['Taluk'] ?? '').trim() === selectedTaluk;

        return matchSearch && matchTaluk;
    });

    displayTaluks(filtered);
    updateVillageCount(filtered);
}
</script>

</body>
</html>
